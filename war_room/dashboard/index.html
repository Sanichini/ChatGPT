<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Domination War Room</title>
    <!-- Load Plotly from CDN -->
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <!-- Load PapaParse for CSV parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js" integrity="sha512-4EK1EsP7lmKzSdXEQRi6FAh54OzNM4Xbz66G1rW8BP5D/3zT5Ip6sPGBtfAu66FHxAzMDJDzHhWhe4gGdLWmXw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
        .container { width: 100%; max-width: 1200px; margin: auto; padding: 20px; }
        h1 { text-align: center; margin-top: 20px; }
        .chart-container { margin: 30px 0; }
        .filters { margin-bottom: 20px; }
        .filters label { margin-right: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Smartphone Market Domination War Room</h1>
        <div class="filters">
            <label for="brandFilter">Brand:</label>
            <select id="brandFilter"></select>
            <label for="marketplaceFilter">Marketplace:</label>
            <select id="marketplaceFilter"></select>
            <label for="priceFilter">Max Price (THB):</label>
            <input type="number" id="priceFilter" min="0" step="100" value="15000">
            <button onclick="applyFilters()">Apply Filters</button>
        </div>
        <div class="chart-container" id="marketShareChart"></div>
        <div class="chart-container" id="priceHeatmap"></div>
        <div class="chart-container" id="featureGap"></div>
    </div>

    <script>
    // Global variables
    let rawData = [];
    let filteredData = [];

    // Populate filters based on data
    function populateFilters() {
        const brandSelect = document.getElementById('brandFilter');
        const marketplaceSelect = document.getElementById('marketplaceFilter');
        const brands = [...new Set(rawData.map(d => d.specs.brand))].sort();
        const marketplaces = [...new Set(rawData.map(d => d.marketplace))].sort();
        brandSelect.innerHTML = '<option value="all">All</option>' + brands.map(b => `<option value="${b}">${b}</option>`).join('');
        marketplaceSelect.innerHTML = '<option value="all">All</option>' + marketplaces.map(m => `<option value="${m}">${m}</option>`).join('');
    }

    function applyFilters() {
        const brand = document.getElementById('brandFilter').value;
        const marketplace = document.getElementById('marketplaceFilter').value;
        const maxPrice = parseFloat(document.getElementById('priceFilter').value || Infinity);
        filteredData = rawData.filter(d => {
            const byBrand = brand === 'all' || d.specs.brand === brand;
            const byMarketplace = marketplace === 'all' || d.marketplace === marketplace;
            const byPrice = d.price <= maxPrice;
            return byBrand && byMarketplace && byPrice;
        });
        drawCharts();
    }

    function drawCharts() {
        // Market Share Pulse: show number of listings per brand over time
        const timeFormat = d3.timeFormat ? d3.timeFormat('%Y-%m-%dT%H:00:00') : undefined;
        const groups = {};
        filteredData.forEach(d => {
            const hour = d.timestamp.slice(0, 13) + ':00:00';
            const brand = d.specs.brand;
            if (!groups[brand]) groups[brand] = {};
            if (!groups[brand][hour]) groups[brand][hour] = 0;
            groups[brand][hour] += 1;
        });
        const traces = [];
        Object.keys(groups).forEach(brand => {
            const hours = Object.keys(groups[brand]).sort();
            traces.push({
                x: hours,
                y: hours.map(h => groups[brand][h]),
                mode: 'lines+markers',
                name: brand
            });
        });
        const layout1 = {
            title: 'Market Share Pulse (Listings per Hour)',
            xaxis: {title: 'Hour'},
            yaxis: {title: 'Listings Count'},
            height: 400
        };
        Plotly.newPlot('marketShareChart', traces, layout1, {responsive: true});

        // Price War Heatmap: matrix of price by product vs marketplace
        const products = [...new Set(filteredData.map(d => d.name))];
        const marketplaces = [...new Set(filteredData.map(d => d.marketplace))];
        const z = products.map(p => {
            return marketplaces.map(m => {
                const item = filteredData.find(d => d.name === p && d.marketplace === m);
                return item ? item.price : null;
            });
        });
        const heatmapData = [{
            z: z,
            x: marketplaces,
            y: products,
            type: 'heatmap',
            colorscale: 'YlGnBu',
            hoverongaps: false
        }];
        const layout2 = {
            title: 'Price War Heatmap (THB)',
            xaxis: {title: 'Marketplace'},
            yaxis: {title: 'Product'},
            height: 500
        };
        Plotly.newPlot('priceHeatmap', heatmapData, layout2, {responsive: true});

        // Feature Gap Analyzer: identify missing features compared with competition
        // We look at a few simple features: RAM, storage, battery.
        const featureCounts = {ram: {}, storage: {}, battery: {}};
        filteredData.forEach(d => {
            const specs = d.specs;
            ['ram', 'storage', 'battery'].forEach(f => {
                const val = specs[f] || 'unknown';
                if (!featureCounts[f][val]) featureCounts[f][val] = 0;
                featureCounts[f][val] += 1;
            });
        });
        const featureTraces = [];
        Object.keys(featureCounts).forEach(feature => {
            featureTraces.push({
                x: Object.keys(featureCounts[feature]),
                y: Object.values(featureCounts[feature]),
                type: 'bar',
                name: feature.toUpperCase()
            });
        });
        const layout3 = {
            title: 'Feature Gap Analyzer',
            barmode: 'group',
            xaxis: {title: 'Feature Value'},
            yaxis: {title: 'Number of Listings'},
            height: 400
        };
        Plotly.newPlot('featureGap', featureTraces, layout3, {responsive: true});
    }

    function loadData() {
        // Load CSV from data/products.csv relative to HTML file
        Papa.parse('..//data/products.csv', {
            header: true,
            download: true,
            skipEmptyLines: true,
            dynamicTyping: true,
            complete: function(results) {
                // Parse JSON specs
                rawData = results.data.map(row => {
                    return {
                        ...row,
                        specs: JSON.parse(row.specs)
                    };
                });
                filteredData = rawData;
                populateFilters();
                drawCharts();
            }
        });
    }

    loadData();
    </script>
</body>
</html>